{% extends "shared/base.html" %} {% block title %}Deworming Management by
Section{% endblock %} {% block content %}
<style>
  .section-container {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 20px;
    margin: 20px;
  }

  .section-sidebar {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    height: fit-content;
  }

  .section-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .section-list li {
    margin-bottom: 10px;
  }

  .section-list a {
    display: block;
    padding: 10px 12px;
    text-decoration: none;
    color: #333;
    border-radius: 5px;
    background: #f5f5f5;
    transition: all 0.3s ease;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-list a:hover {
    background: #e9ecef;
    color: #8a3243;
  }

  .section-list a.active {
    background: #8a3243;
    color: white;
    font-weight: bold;
  }

  .section-count {
    display: inline-block;
    background: #6c757d;
    color: white;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 11px;
  }

  .section-list a.active .section-count {
    background: rgba(255, 255, 255, 0.3);
  }

  .main-content {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
  }

  .section-header h3 {
    margin: 0;
    color: #333;
  }

  .section-actions {
    display: flex;
    gap: 10px;
  }

  .btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: #a83e51;
    color: white;
  }

  .btn-primary:hover {
    background: #8a3243;
  }

  .btn-success {
    background: #28a745;
    color: white;
  }

  .btn-success:hover {
    background: #218838;
  }

  .btn-warning {
    background: #ffc107;
    color: black;
  }

  .btn-warning:hover {
    background: #e0a800;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }
  
  .btn-sm {
    padding: 5px 10px;
    font-size: 12px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 13px;
  }

  table thead {
    background: #f8f9fa;
  }

  table th {
    padding: 10px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #dee2e6;
  }

  table td {
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
  }

  table tr:hover {
    background: #f5f5f5;
  }

  .badge {
    display: inline-block;
    padding: 3px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
  }

  .badge-yes {
    background: #d1e7dd;
    color: #0f5132;
  }

  .badge-no {
    background: #f8d7da;
    color: #842029;
  }

  .action-buttons {
    display: flex;
    gap: 5px;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white;
    border-radius: 8px;
    padding: 30px;
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
  }

  .modal-header h4 {
    margin: 0;
    color: #333;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #a83e51;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 60px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .form-row-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
  }

  .required::after {
    content: " *";
    color: red;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 25px;
  }

  .loading {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #0d6efd;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .alert {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 15px;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .no-section {
    text-align: center;
    padding: 60px 40px;
    color: #6c757d;
  }

  .no-section i {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 20px;
  }

  .section-title {
    color: #666;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 15px;
    margin-bottom: 10px;
    padding-left: 5px;
    border-left: 3px solid #a83e51;
  }
</style>

<div class="section-container">
  <!-- Sidebar with sections -->
  <div class="section-sidebar">
    <h5 style="margin-top: 0">Sections</h5>
    <ul class="section-list">
      {% if section_counts %} {% for section in sections %}
      <li>
        <a
          href="?section={{ section | urlencode }}"
          class="{% if selected_section == section %}active{% endif %}"
        >
          <span>{{ section }}</span>
          <span class="section-count"
            >{{ section_counts.get(section, 0) }}</span
          >
        </a>
      </li>
      {% endfor %} {% else %}
      <li style="text-align: center; color: #999; padding: 20px 0">
        No sections found
      </li>
      {% endif %}
    </ul>
  </div>

  <!-- Main content -->
  <div class="main-content">
    {% if selected_section %}
    <div class="section-header">
      <h3><i class="bx bxs-group"></i> Section: {{ selected_section }}</h3>
      <div class="section-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="bx bx-plus"></i> Add Record
        </button>
        {% if deworming_records %}
        <a
          href="/deworming-section-print/{{ selected_section | urlencode }}"
          class="btn btn-success"
          target="_blank"
        >
          <i class="bx bx-printer"></i> Print
        </a>
        {% endif %}
      </div>
    </div>

    {% if deworming_records %}
    <table>
      <thead>
        <tr>
          <th>No.</th>
          <th>LRN</th>
          <th>Name</th>
          <th>Grade</th>
          <th>Pre 4Ps</th>
          <th>Pre Consent</th>
          <th>Post 4Ps</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for record in deworming_records %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ record['lrn'] or '-' }}</td>
          <td>{{ record['name'] }}</td>
          <td>{{ record['grade'] or '-' }}</td>
          <td>
            <span
              class="badge badge-{{ ('yes' if record['pre_4ps_recipient'] in ['YES', 'Yes', 'yes'] else 'no') }}"
            >
              {{ record['pre_4ps_recipient'] or '-' }}
            </span>
          </td>
          <td>
            <span
              class="badge badge-{{ ('yes' if record['pre_deworming_consent'] in ['YES', 'Yes', 'yes'] else 'no') }}"
            >
              {{ record['pre_deworming_consent'] or '-' }}
            </span>
          </td>
          <td>
            <span
              class="badge badge-{{ ('yes' if record['post_4ps_children'] in ['YES', 'Yes', 'yes'] else 'no') }}"
            >
              {{ record['post_4ps_children'] or '-' }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button
                class="btn btn-sm btn-warning btn-edit-deworming"
                data-record-id="{{ record['id'] | int }}"
              >
                <i class="bx bx-edit"></i>
              </button>
              <button
                class="btn btn-sm btn-danger btn-delete-deworming"
                data-record-id="{{ record['id'] | int }}"
              >
                <i class="bx bx-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <p>No deworming records found for this section.</p>
      <button
        class="btn btn-primary"
        onclick="openAddModal()"
        style="margin-top: 15px"
      >
        Add First Record
      </button>
    </div>
    {% endif %} {% else %}
    <div class="no-section">
      <i class="bx bx-folder-open"></i>
      <p>Select a section from the left to view records</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="deworming-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h4 id="modal-title">Add Deworming Record</h4>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div id="modal-alert"></div>
    <form id="deworming-form">
      <div class="form-row">
        <div class="form-group">
          <label for="personType" class="required">Person Type</label>
          <select id="personType" name="person_type" required>
            <option value="">Select Type</option>
            <option value="Student">Student</option>
            <option value="Teacher">Teacher</option>
          </select>
        </div>
        <div class="form-group">
          <label for="lrn">LRN</label>
          <input
            type="text"
            id="lrn"
            name="lrn"
            placeholder="Learner Reference Number"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="name" class="required">Name</label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Full Name"
          required
        />
      </div>

      <div class="form-row-3">
        <div class="form-group">
          <label for="grade">Grade</label>
          <input
            type="text"
            id="grade"
            name="grade"
            placeholder="e.g., Grade 7"
          />
        </div>
        <div class="form-group">
          <label for="section" class="required">Section</label>
          <input
            type="text"
            id="section"
            name="section"
            value="{{ selected_section }}"
            required
            readonly
          />
        </div>
        <div class="form-group">
          <label for="schoolYear">School Year</label>
          <input
            type="text"
            id="schoolYear"
            name="school_year"
            placeholder="e.g., 2024-2025"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="recordedDate" class="required">Date Recorded</label>
        <input type="date" id="recordedDate" name="recorded_date" required />
      </div>

      <div class="section-title">Pre-Deworming Assessment</div>
      <div class="form-row-3">
        <div class="form-group">
          <label for="pre4psRecipient">4Ps Recipient (YES/NO)</label>
          <select id="pre4psRecipient" name="pre_4ps_recipient">
            <option value="">Select</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pre4psConsent">4Ps with Consent (YES/NO)</label>
          <select id="pre4psConsent" name="pre_4ps_with_consent">
            <option value="">Select</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div class="form-group">
          <label for="preNon4psConsent">Non-4Ps Consent (YES/NO)</label>
          <select id="preNon4psConsent" name="pre_non_4ps_consent">
            <option value="">Select</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="preDeworming">Consented to Deworming (YES/NO)</label>
        <select id="preDeworming" name="pre_deworming_consent">
          <option value="">Select</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div class="section-title">Post-Deworming Assessment</div>
      <div class="form-row-3">
        <div class="form-group">
          <label for="post4psChildren">4Ps Children Dewormed (YES/NO)</label>
          <select id="post4psChildren" name="post_4ps_children">
            <option value="">Select</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div class="form-group">
          <label for="postNon4psChildren"
            >Non-4Ps Children Dewormed (YES/NO)</label
          >
          <select id="postNon4psChildren" name="post_non_4ps_children">
            <option value="">Select</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div class="form-group">
          <label for="postSerious"
            >Serious Illness/Hyperactivity (YES/NO)</label
          >
          <select id="postSerious" name="post_serious_illness">
            <option value="">Select</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="postAdverse">Adverse Effect (YES/NO)</label>
        <select id="postAdverse" name="post_adverse_effect">
          <option value="">Select</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div class="form-group">
        <label for="remarks">Remarks</label>
        <textarea
          id="remarks"
          name="remarks"
          placeholder="Additional notes..."
        ></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-warning" onclick="closeModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          <span id="submit-text">Save Record</span>
          <span
            id="submit-loading"
            class="loading"
            style="display: none"
          ></span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentRecordId = null;
  const selectedSection = "{{ selected_section }}";

  function openAddModal() {
    if (!selectedSection) {
      alert("Please select a section first");
      return;
    }
    currentRecordId = null;
    document.getElementById("deworming-form").reset();
    document.getElementById("modal-title").textContent = "Add Deworming Record";
    document.getElementById("section").value = selectedSection;
    document.getElementById("deworming-modal").classList.add("active");
  }

  async function openEditModal(recordId) {
    try {
      const response = await fetch(`/api/deworming/${recordId}`);
      const data = await response.json();

      if (!data.success) {
        alert("Error loading record");
        return;
      }

      const record = data.record;
      currentRecordId = recordId;

      document.getElementById("deworming-form").reset();
      document.getElementById("personType").value = record.person_type || "";
      document.getElementById("lrn").value = record.lrn || "";
      document.getElementById("name").value = record.name || "";
      document.getElementById("grade").value = record.grade || "";
      document.getElementById("section").value = record.section || "";
      document.getElementById("schoolYear").value = record.school_year || "";
      document.getElementById("recordedDate").value =
        record.recorded_date || "";

      document.getElementById("pre4psRecipient").value =
        record.pre_4ps_recipient || "";
      document.getElementById("pre4psConsent").value =
        record.pre_4ps_with_consent || "";
      document.getElementById("preNon4psConsent").value =
        record.pre_non_4ps_consent || "";
      document.getElementById("preDeworming").value =
        record.pre_deworming_consent || "";

      document.getElementById("post4psChildren").value =
        record.post_4ps_children || "";
      document.getElementById("postNon4psChildren").value =
        record.post_non_4ps_children || "";
      document.getElementById("postSerious").value =
        record.post_serious_illness || "";
      document.getElementById("postAdverse").value =
        record.post_adverse_effect || "";

      document.getElementById("remarks").value = record.remarks || "";

      document.getElementById("modal-title").textContent =
        "Edit Deworming Record";
      document.getElementById("deworming-modal").classList.add("active");
    } catch (error) {
      alert("Error: " + error.message);
    }
  }

  function closeModal() {
    document.getElementById("deworming-modal").classList.remove("active");
    currentRecordId = null;
  }

  document
    .getElementById("deworming-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitBtn = document.querySelector(
        ".modal-actions button[type='submit']"
      );
      const submitText = document.getElementById("submit-text");
      const submitLoading = document.getElementById("submit-loading");

      submitText.style.display = "none";
      submitLoading.style.display = "inline-block";
      submitBtn.disabled = true;

      try {
        const formData = new FormData(
          document.getElementById("deworming-form")
        );
        const url = currentRecordId
          ? `/api/deworming/edit/${currentRecordId}`
          : "/api/deworming/add";

        const response = await fetch(url, {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          showAlert(data.message, "danger");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "danger");
      } finally {
        submitText.style.display = "inline";
        submitLoading.style.display = "none";
        submitBtn.disabled = false;
      }
    });

  async function deleteRecord(recordId) {
    if (!confirm("Are you sure you want to delete this record?")) {
      return;
    }

    try {
      const response = await fetch(`/api/deworming/delete/${recordId}`, {
        method: "DELETE",
      });

      const data = await response.json();

      if (data.success) {
        location.reload();
      } else {
        alert("Error: " + data.message);
      }
    } catch (error) {
      alert("Error: " + error.message);
    }
  }

  function showAlert(message, type) {
    const alertDiv = document.getElementById("modal-alert");
    alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  }

  // Close modal when clicking outside
  document.getElementById("deworming-modal").addEventListener("click", (e) => {
    if (e.target === document.getElementById("deworming-modal")) {
      closeModal();
    }
  });

  // Event delegation for edit and delete buttons
  document.addEventListener("DOMContentLoaded", function () {
    document
      .querySelectorAll(".btn-edit-deworming[data-record-id]")
      .forEach((btn) => {
        btn.addEventListener("click", function () {
          const recordId = this.getAttribute("data-record-id");
          openEditModal(recordId);
        });
      });

    document
      .querySelectorAll(".btn-delete-deworming[data-record-id]")
      .forEach((btn) => {
        btn.addEventListener("click", function () {
          const recordId = this.getAttribute("data-record-id");
          deleteRecord(recordId);
        });
      });
  });
</script>
{% endblock %}
