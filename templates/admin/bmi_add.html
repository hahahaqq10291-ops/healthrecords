{% extends "shared/base.html" %} {% block extra_css %}
<style>
  .form-container {
    max-width: 600px;
    margin: 2rem auto;
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .form-container h2 {
    color: #333;
    margin-bottom: 2rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    color: #333;
    font-weight: 500;
  }

  .required {
    color: #dc3545;
  }

  input[type="text"],
  input[type="date"],
  input[type="number"],
  input[type="email"],
  select,
  textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
    box-sizing: border-box;
  }

  textarea {
    resize: vertical;
    min-height: 100px;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #a83e51;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .btn-group {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
    flex: 1;
  }

  .btn-submit {
    background: #a83e51;
    color: white;
  }

  .btn-submit:hover {
    background: #8a3243;
  }

  .btn-cancel {
    background: #e9ecef;
    color: #333;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-cancel:hover {
    background: #dee2e6;
  }

  @media (max-width: 600px) {
    .form-row {
      grid-template-columns: 1fr;
    }

    .btn-group {
      flex-direction: column;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="form-container">
  <h2>Add New BMI Record</h2>

  <form id="bmiForm">
    <div class="form-group">
      <label>Person Type <span class="required">*</span></label>
      <select name="person_type" required>
        <option value="">Select...</option>
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
      </select>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>LRN (Learner Reference Number) <span class="required">*</span></label>
        <input type="text" name="person_id" placeholder="e.g., 108095070657" required />
      </div>
      <div class="form-group">
        <label>Full Name <span class="required">*</span></label>
        <input
          type="text"
          name="name"
          placeholder="LastName, FirstName"
          required
        />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Date of Birth</label>
        <input type="date" name="birthdate" id="birthdateInput" />
      </div>
      <div class="form-group">
        <label>Record Date <span class="required">*</span></label>
        <input type="date" name="record_date" id="recordDateInput" required />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Grade/Level</label>
        <input type="text" name="grade" placeholder="e.g., 11" />
      </div>
      <div class="form-group">
        <label>Section</label>
        <input type="text" name="section" placeholder="e.g., A" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Height (m) <span class="required">*</span></label>
        <input
          type="number"
          name="height"
          id="heightInput"
          step="0.01"
          placeholder="e.g., 1.60"
          required
        />
      </div>
      <div class="form-group">
        <label>Weight (kg) <span class="required">*</span></label>
        <input
          type="number"
          name="weight"
          id="weightInput"
          step="0.1"
          placeholder="e.g., 50.5"
          required
        />
      </div>
    </div>

    <!-- BMI Results Display -->
    <div id="bmiResults" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: #f0f8ff; border-radius: 4px; border-left: 4px solid #a83e51;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div>
          <label style="font-weight: 600; color: #333; margin-bottom: 0.25rem; display: block;">üìä BMI Value:</label>
          <p id="bmiValue" style="margin: 0; font-size: 1.3rem; color: #a83e51; font-weight: bold;">-</p>
        </div>
        <div>
          <label style="font-weight: 600; color: #333; margin-bottom: 0.25rem; display: block;">üìà Nutritional Status:</label>
          <p id="nutritionalStatusDisplay" style="margin: 0; font-size: 1.3rem; color: #0f5132; font-weight: bold;">-</p>
        </div>
      </div>
      <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #dee2e6;">
        <label style="font-weight: 600; color: #333; margin-bottom: 0.25rem; display: block;">üìè Height for Age:</label>
        <p id="heightForAgeDisplay" style="margin: 0; font-size: 1rem; color: #666;">-</p>
      </div>
    </div>

    <!-- Hidden fields to store auto-calculated values -->
    <input type="hidden" name="nutritional_status" id="nutritionalStatus" value="" />
    <input type="hidden" name="height_for_age" id="heightForAge" value="" />

    <div class="form-group">
      <label>Remarks</label>
      <textarea name="remarks" placeholder="Additional notes..."></textarea>
    </div>

    <div class="btn-group">
      <a href="{{ url_for('bmi_management') }}" class="btn btn-cancel"
        >Cancel</a
      >
      <button type="submit" class="btn btn-submit">Add Record</button>
    </div>
  </form>
</div>

<script>
  // BMI Calculation Function
  function calculateBMI() {
    const height = parseFloat(document.getElementById("heightInput").value);
    const weight = parseFloat(document.getElementById("weightInput").value);
    const birthdate = document.getElementById("birthdateInput").value;
    const recordDate = document.getElementById("recordDateInput").value;

    if (!height || !weight || isNaN(height) || isNaN(weight)) {
      document.getElementById("bmiResults").style.display = "none";
      return;
    }

    if (height <= 0 || weight <= 0) {
      alert("Height and weight must be greater than 0");
      return;
    }

    // Calculate BMI
    const bmi = weight / (height * height);
    const bmiValue = bmi.toFixed(2);

    // Classify BMI - 6 Tier System
    let nutritionalStatus = "";
    if (bmi < 15) {
      nutritionalStatus = "Severely wasted";
    } else if (bmi < 18.5) {
      nutritionalStatus = "Wasted";
    } else if (bmi < 25) {
      nutritionalStatus = "Normal";
    } else if (bmi < 30) {
      nutritionalStatus = "Overweight";
    } else if (bmi <= 40) {
      nutritionalStatus = "Obese";
    } else {
      nutritionalStatus = "Morbidly Obese";
    }

    // Calculate Height for Age if DOB is provided
    let heightForAge = "-";
    if (birthdate) {
      heightForAge = classifyHeightForAge(birthdate, height, recordDate);
    }

    // Update display and hidden fields
    document.getElementById("bmiValue").textContent = bmiValue;
    document.getElementById("nutritionalStatusDisplay").textContent =
      nutritionalStatus;
    document.getElementById("heightForAgeDisplay").textContent = heightForAge;
    document.getElementById("nutritionalStatus").value = nutritionalStatus;
    document.getElementById("heightForAge").value = heightForAge;
    document.getElementById("bmiResults").style.display = "block";
  }

  // Height for Age Classification using WHO/CDC Standards
  function classifyHeightForAge(birthdate, height, recordDate) {
    if (!birthdate) return "-";

    const birth = new Date(birthdate);
    const record = recordDate ? new Date(recordDate) : new Date();

    let ageInMonths = (record.getFullYear() - birth.getFullYear()) * 12;
    ageInMonths += record.getMonth() - birth.getMonth();
    ageInMonths += record.getDate() < birth.getDate() ? -1 : 0;

    const ageInYears = ageInMonths / 12;

    // WHO/CDC Height-for-Age Standards (approximate values for ages 6-18)
    // Based on median height + 2 standard deviations
    const standards = {
      6: { male: 1.14, female: 1.12 },
      7: { male: 1.20, female: 1.18 },
      8: { male: 1.26, female: 1.24 },
      9: { male: 1.31, female: 1.30 },
      10: { male: 1.37, female: 1.37 },
      11: { male: 1.43, female: 1.43 },
      12: { male: 1.49, female: 1.49 },
      13: { male: 1.55, female: 1.54 },
      14: { male: 1.61, female: 1.58 },
      15: { male: 1.66, female: 1.60 },
      16: { male: 1.70, female: 1.62 },
      17: { male: 1.73, female: 1.63 },
      18: { male: 1.75, female: 1.64 },
    };

    const age = Math.floor(ageInYears);

    if (age < 6 || age > 18) {
      return "Age out of range (6-18)";
    }

    const expectedHeight = standards[age]?.male || standards[age]?.female;
    const stunting_threshold = expectedHeight * 0.9; // 90% of median is stunted

    if (height < stunting_threshold) {
      return "Stunted";
    } else {
      return "Normal";
    }
  }

  // Attach event listeners for real-time calculation
  document
    .getElementById("heightInput")
    .addEventListener("change", calculateBMI);
  document
    .getElementById("weightInput")
    .addEventListener("change", calculateBMI);
  document
    .getElementById("birthdateInput")
    .addEventListener("change", calculateBMI);

  // Form submission handler
  document
    .getElementById("bmiForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      try {
        const response = await fetch('{{ url_for("bmi_add") }}', {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          alert(data.message);
          window.location.href = '{{ url_for("bmi_management") }}';
        } else {
          alert("Error: " + data.message);
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred. Please try again.");
      }
    });
</script>
{% endblock %}
