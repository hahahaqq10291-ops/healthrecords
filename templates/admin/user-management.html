{% extends "shared/base.html" %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/student_list.css') }}"
/>
<style>
  .management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    gap: 20px;
  }

  .button-group {
    display: flex;
    gap: 10px;
  }

  .btn-action {
    padding: 10px 20px;
    background-color: #8f2f41;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
  }

  .btn-action:hover {
    background-color: #a83e51;
  }

  .btn-action.secondary {
    background-color: #8f2f41;
  }

  .btn-action.secondary:hover {
    background-color: #a83e51;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .modal.show {
    display: block;
  }

  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    animation: slideIn 0.3s;
    max-height: 90vh;
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .modal-content::-webkit-scrollbar {
    display: none;
  }

  @keyframes slideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 20px;
  }

  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
  }

  .close:hover {
    color: black;
  }

  .form-card {
    border: none;
    box-shadow: none;
    padding: 0;
  }

  .form-card input,
  .form-card textarea {
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
    font-size: 14px;
    box-sizing: border-box;
  }

  .form-card input:focus,
  .form-card textarea:focus {
    outline: none;
    border-color: #b65a6b;
    box-shadow: 0 0 5px #8f2f41;
  }

  .btn-primary {
    background-color: #8f2f41;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
  }

  .btn-primary:hover {
    background-color: #a83e51;
  }

  .section-title {
    margin-top: 40px;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: bold;
    border-bottom: 2px solid #b65a6b;
    padding-bottom: 10px;
  }

  .table-wrapper {
    overflow-x: auto;
    margin-bottom: 30px;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .table-wrapper::-webkit-scrollbar {
    display: none;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  table th,
  table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  table th {
    background-color: #a83e51;
    font-weight: bold;
    color: white;
  }

  table tr:hover {
    background-color: #f5f5f5;
  }

  .action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
  }

  .btn-edit {
    background-color: #ffc107;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
    transition: 0.3s;
  }

  .btn-edit:hover {
    background-color: #e0a800;
  }

  .btn-delete {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
    transition: 0.3s;
  }

  .btn-delete:hover {
    background-color: #c82333;
  }

  /* Delete Confirmation Modal */
  .delete-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
  }

  .delete-modal.show {
    display: block;
  }

  .delete-modal-content {
    background-color: #fefefe;
    margin: 20% auto;
    padding: 30px;
    border: 1px solid #dc3545;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    animation: slideIn 0.3s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  }

  .delete-modal-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
  }

  .delete-modal-header i {
    font-size: 28px;
    color: #dc3545;
  }

  .delete-modal-header h3 {
    margin: 0;
    color: #dc3545;
    font-size: 18px;
  }

  .delete-modal-body {
    color: #333;
    margin-bottom: 20px;
    font-size: 14px;
    line-height: 1.6;
  }

  .delete-modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .delete-modal-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background-color 0.3s;
  }

  .delete-confirm-btn {
    background-color: #dc3545;
    color: white;
  }

  .delete-confirm-btn:hover {
    background-color: #c82333;
  }

  .delete-cancel-btn {
    background-color: #e0e0e0;
    color: #333;
  }

  .delete-cancel-btn:hover {
    background-color: #d0d0d0;
  }

  /* Search Bar Styling */
  .search-container {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-input {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }

  .search-input:focus {
    outline: none;
    border-color: #a83e51;
    box-shadow: 0 0 5px #b65a6b;
  }

  .search-label {
    font-weight: 600;
    color: #333;
    white-space: nowrap;
  }

  .no-results {
    padding: 20px;
    text-align: center;
    color: #666;
    background-color: #f9f9f9;
    border-radius: 4px;
    margin-top: 10px;
  }

  /* Pagination Styles */
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 25px;
    margin-bottom: 30px;
  }

  .pagination {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .pagination-btn {
    padding: 8px 15px;
    background-color: #8f2f41;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background-color 0.3s;
  }

  .pagination-btn:hover:not(:disabled) {
    background-color: #a83e51;
  }

  .pagination-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .pagination-info {
    font-size: 14px;
    color: #333;
    font-weight: 500;
    min-width: 150px;
    text-align: center;
  }
</style>
{% endblock %} {% block content %}
<div class="management-header">
  <h1>User Management</h1>
  <div class="button-group">
    <button class="btn-action" onclick="openStudentModal()">
      + Add Student
    </button>
    <button class="btn-action secondary" onclick="openTeacherModal()">
      + Add Teacher
    </button>
  </div>
</div>

<!-- Add Student Modal -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Student</h2>
      <button class="close" onclick="closeStudentModal()">&times;</button>
    </div>
    <form
      action="{{ url_for('add_student') }}"
      method="POST"
      class="form-card"
      id="addStudentForm"
      onsubmit="return validateStudentForm()"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input
        type="text"
        name="studentLRN"
        placeholder="Student LRN"
        required
        minlength="3"
        maxlength="20"
        pattern="[a-zA-Z0-9-]+"
        title="LRN should contain only letters, numbers, and hyphens"
      />
      <input
        type="text"
        name="name"
        placeholder="Full Name"
        required
        minlength="3"
        maxlength="100"
        pattern="[a-zA-Z\s]+"
        title="Name should contain only letters and spaces"
      />
      <input
        type="text"
        name="class"
        placeholder="Class/Grade"
        required
        maxlength="20"
      />
      <input
        type="text"
        name="strand"
        placeholder="Strand (e.g., STEM, ABM, HUMSS)"
        maxlength="50"
      />
      <input type="date" name="dob" required />
      <input type="text" name="address" placeholder="Address" maxlength="150" />
      <input
        type="text"
        name="parentContact"
        placeholder="Parent/Guardian's Name"
        maxlength="100"
        pattern="[a-zA-Z\s]+"
        title="Parent name should contain only letters and spaces"
      />
      <input
        type="tel"
        name="emergencyContact"
        placeholder="Emergency Contact Number"
        pattern="[0-9\-\+\(\)\s]+"
        maxlength="15"
        title="Please enter a valid phone number"
      />
      <input
        type="number"
        name="height"
        placeholder="Height (cm)"
        min="50"
        max="250"
      />
      <input
        type="number"
        name="weight"
        placeholder="Weight (kg)"
        min="10"
        max="300"
      />
      <input type="text" name="blood" placeholder="Blood Type" maxlength="5" />
      <textarea
        name="pastIllnesses"
        placeholder="Past Illnesses"
        maxlength="500"
      ></textarea>
      <textarea
        name="allergies"
        placeholder="Allergies"
        maxlength="500"
      ></textarea>
      <textarea
        name="conditions"
        placeholder="Pre-existing Conditions"
        maxlength="500"
      ></textarea>
      <input
        type="text"
        name="vaccination"
        placeholder="Vaccination Status"
        maxlength="100"
      />
      <button type="submit" class="btn-primary">Save Student</button>
    </form>
  </div>
</div>

<!-- Add Teacher Modal -->
<div id="teacherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Teacher</h2>
      <button class="close" onclick="closeTeacherModal()">&times;</button>
    </div>
    <form
      action="{{ url_for('add_teacher') }}"
      method="POST"
      class="form-card"
      id="addTeacherForm"
      onsubmit="return validateTeacherForm()"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input
        type="text"
        name="teacherID"
        placeholder="Teacher ID"
        required
        minlength="3"
        maxlength="20"
        pattern="[a-zA-Z0-9-]+"
        title="Teacher ID should contain only letters, numbers, and hyphens"
      />
      <input
        type="text"
        name="name"
        placeholder="Full Name"
        required
        minlength="3"
        maxlength="100"
        pattern="[a-zA-Z\s]+"
        title="Name should contain only letters and spaces"
      />
      <input
        type="text"
        name="department"
        placeholder="Department / Subject"
        required
        maxlength="50"
      />
      <input type="date" name="dob" required />
      <input type="text" name="address" placeholder="Address" maxlength="150" />
      <input
        type="tel"
        name="contact"
        placeholder="Contact Number"
        pattern="[0-9\-\+\(\)\s]+"
        maxlength="15"
        title="Please enter a valid phone number"
      />
      <input
        type="number"
        name="height"
        placeholder="Height (cm)"
        min="50"
        max="250"
      />
      <input
        type="number"
        name="weight"
        placeholder="Weight (kg)"
        min="10"
        max="300"
      />
      <input type="text" name="blood" placeholder="Blood Type" maxlength="5" />
      <textarea
        name="pastIllnesses"
        placeholder="Past Illnesses"
        maxlength="500"
      ></textarea>
      <textarea
        name="allergies"
        placeholder="Allergies"
        maxlength="500"
      ></textarea>
      <textarea
        name="conditions"
        placeholder="Pre-existing Conditions"
        maxlength="500"
      ></textarea>
      <input
        type="text"
        name="vaccination"
        placeholder="Vaccination Status"
        maxlength="100"
      />
      <button type="submit" class="btn-primary">Save Teacher</button>
    </form>
  </div>
</div>

<!-- Students Section -->
<div class="section-title">Students</div>
<div class="search-container">
  <label class="search-label" for="studentSearchInput">Search by LRN:</label>
  <input
    type="text"
    id="studentSearchInput"
    class="search-input"
    placeholder="Enter student LRN..."
    onkeyup="filterStudentTable()"
  />
  <label class="search-label" for="classFilterSelect">Filter by Class:</label>
  <select
    id="classFilterSelect"
    class="search-input"
    onchange="filterStudentTable()"
  >
    <option value="">All Classes</option>
    {% set classes = students | map(attribute='class') | select | unique | sort
    %} {% for class_name in classes %} {% if class_name %}
    <option value="{{ class_name }}">{{ class_name }}</option>
    {% endif %} {% endfor %}
  </select>
  <label class="search-label" for="strandFilterSelect">Filter by Strand:</label>
  <select
    id="strandFilterSelect"
    class="search-input"
    onchange="filterStudentTable()"
  >
    <option value="">All Strands</option>
    {% set strands = students | map(attribute='strand') | select | unique | sort
    %} {% for strand_name in strands %} {% if strand_name %}
    <option value="{{ strand_name }}">{{ strand_name }}</option>
    {% endif %} {% endfor %}
  </select>
</div>

<div class="table-wrapper">
  <table id="studentTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>LRN</th>
        <th>Name</th>
        <th>Class</th>
        <th>Strand</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for student in students %}
      <tr>
        <td>{{ student.id }}</td>
        <td>{{ student.studentLRN }}</td>
        <td>{{ student.name }}</td>
        <td>{{ student.class }}</td>
        <td>{{ student.strand or '-' }}</td>
        <td>
          <div class="action-buttons">
            <button
              type="button"
              class="btn-action btn-sm btn-edit btn-edit-student"
              data-id="{{ student.id }}"
              data-lrn="{{ student.studentLRN }}"
              data-name="{{ student.name }}"
              data-class="{{ student.class }}"
              data-strand="{{ student.strand or '' }}"
              data-dob="{{ student.dob or '' }}"
              data-address="{{ student.address or '' }}"
              data-parent="{{ student.parentContact or '' }}"
              data-emergency="{{ student.emergencyContact or '' }}"
              data-height="{{ student.height or '' }}"
              data-weight="{{ student.weight or '' }}"
              data-blood="{{ student.blood or '' }}"
              data-illnesses="{{ student.pastIllnesses or '' }}"
              data-allergies="{{ student.allergies or '' }}"
              data-conditions="{{ student.conditions or '' }}"
              data-vaccination="{{ student.vaccination or '' }}"
            >
              Edit
            </button>
            <button
              type="button"
              class="btn-action btn-sm btn-delete btn-delete-student"
              data-type="student"
              data-id="{{ student.id }}"
              data-name="{{ student.name }}"
            >
              Delete
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if show_student_pagination %}
<div id="studentPaginationContainer" class="pagination-container">
  <nav class="pagination">
    <button
      id="studentPrevBtn"
      class="pagination-btn"
      onclick="previousStudentPage()"
    >
      ← Previous
    </button>
    <div class="pagination-info">
      <span
        >Page <span id="studentCurrentPage">1</span> of
        <span id="studentTotalPages">{{ student_pages }}</span></span
      >
    </div>
    <button
      id="studentNextBtn"
      class="pagination-btn"
      onclick="nextStudentPage()"
    >
      Next →
    </button>
  </nav>
</div>
{% endif %}
<div class="section-title">Teachers</div>
<div class="search-container">
  <label class="search-label" for="teacherSearchInput"
    >Search by Teacher Code:</label
  >
  <input
    type="text"
    id="teacherSearchInput"
    class="search-input"
    placeholder="Enter teacher code..."
    onkeyup="filterTeacherTable()"
  />
</div>
<div class="table-wrapper">
  <table id="teacherTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Teacher Code</th>
        <th>Name</th>
        <th>Department</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for teacher in teachers %}
      <tr>
        <td>{{ teacher.id }}</td>
        <td>{{ teacher.teacherID }}</td>
        <td>{{ teacher.name }}</td>
        <td>{{ teacher.department }}</td>
        <td>
          <div class="action-buttons">
            <button
              type="button"
              class="btn-action btn-sm btn-edit btn-edit-teacher"
              data-id="{{ teacher.id }}"
              data-teacher-id="{{ teacher.teacherID }}"
              data-name="{{ teacher.name }}"
              data-department="{{ teacher.department }}"
              data-dob="{{ teacher.dob or '' }}"
              data-address="{{ teacher.address or '' }}"
              data-contact="{{ teacher.contact or '' }}"
              data-height="{{ teacher.height or '' }}"
              data-weight="{{ teacher.weight or '' }}"
              data-blood="{{ teacher.blood or '' }}"
              data-illnesses="{{ teacher.pastIllnesses or '' }}"
              data-allergies="{{ teacher.allergies or '' }}"
              data-conditions="{{ teacher.conditions or '' }}"
              data-vaccination="{{ teacher.vaccination or '' }}"
            >
              Edit
            </button>
            <button
              type="button"
              class="btn-action btn-sm btn-delete btn-delete-teacher"
              data-type="teacher"
              data-id="{{ teacher.id }}"
              data-name="{{ teacher.name }}"
            >
              Delete
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if show_teacher_pagination %}
<div id="teacherPaginationContainer" class="pagination-container">
  <nav class="pagination">
    <button
      id="teacherPrevBtn"
      class="pagination-btn"
      onclick="previousTeacherPage()"
    >
      ← Previous
    </button>
    <div class="pagination-info">
      <span
        >Page <span id="teacherCurrentPage">1</span> of
        <span id="teacherTotalPages">{{ teacher_pages }}</span></span
      >
    </div>
    <button
      id="teacherNextBtn"
      class="pagination-btn"
      onclick="nextTeacherPage()"
    >
      Next →
    </button>
  </nav>
</div>
{% endif %}
<div id="deleteModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <i class="bx bxs-exclamation-circle"></i>
      <h3>Confirm Delete</h3>
    </div>
    <div class="delete-modal-body">
      <p>
        Are you sure you want to delete <strong id="deleteModalName"></strong>?
      </p>
      <p style="color: #dc3545; font-size: 12px; margin-top: 10px">
        ⚠️ This action cannot be undone.
      </p>
    </div>
    <div class="delete-modal-buttons">
      <button class="delete-cancel-btn" onclick="closeDeleteModal()">
        Cancel
      </button>
      <button class="delete-confirm-btn" onclick="confirmDelete()">
        Delete
      </button>
    </div>
  </div>
</div>

<script>
  // Student Modal Functions
  function openStudentModal() {
    document.getElementById("studentModal").classList.add("show");
  }

  function closeStudentModal() {
    document.getElementById("studentModal").classList.remove("show");
  }

  // Teacher Modal Functions
  function openTeacherModal() {
    document.getElementById("teacherModal").classList.add("show");
  }

  function closeTeacherModal() {
    document.getElementById("teacherModal").classList.remove("show");
  }

  // Event delegation for edit student buttons
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("btn-edit-student")) {
      const btn = e.target;
      openEditStudentModal(
        btn.dataset.id,
        btn.dataset.lrn,
        btn.dataset.name,
        btn.dataset.class,
        btn.dataset.strand,
        btn.dataset.dob,
        btn.dataset.address,
        btn.dataset.parent,
        btn.dataset.emergency,
        btn.dataset.height,
        btn.dataset.weight,
        btn.dataset.blood,
        btn.dataset.illnesses,
        btn.dataset.allergies,
        btn.dataset.conditions,
        btn.dataset.vaccination
      );
    }
  });

  // Event delegation for edit teacher buttons
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("btn-edit-teacher")) {
      const btn = e.target;
      openEditTeacherModal(
        btn.dataset.id,
        btn.dataset.teacherId,
        btn.dataset.name,
        btn.dataset.department,
        btn.dataset.dob,
        btn.dataset.address,
        btn.dataset.contact,
        btn.dataset.height,
        btn.dataset.weight,
        btn.dataset.blood,
        btn.dataset.illnesses,
        btn.dataset.allergies,
        btn.dataset.conditions,
        btn.dataset.vaccination
      );
    }
  });

  // Event delegation for delete buttons
  document.addEventListener("click", function (e) {
    if (
      e.target.classList.contains("btn-delete-student") ||
      e.target.classList.contains("btn-delete-teacher")
    ) {
      const btn = e.target;
      openDeleteModal(btn.dataset.type, btn.dataset.id, btn.dataset.name);
    }
  });

  // Close modal when clicking outside of it (merged window.onclick)
  window.onclick = function (event) {
    const studentModal = document.getElementById("studentModal");
    const teacherModal = document.getElementById("teacherModal");
    const deleteModal = document.getElementById("deleteModal");
    const editStudentModal = document.getElementById("editStudentModal");
    const editTeacherModal = document.getElementById("editTeacherModal");

    if (event.target === studentModal) {
      studentModal.classList.remove("show");
    }
    if (event.target === teacherModal) {
      teacherModal.classList.remove("show");
    }
    if (event.target === deleteModal) {
      deleteModal.classList.remove("show");
    }
    if (event.target === editStudentModal) {
      editStudentModal.classList.remove("show");
    }
    if (event.target === editTeacherModal) {
      editTeacherModal.classList.remove("show");
    }
  };

  // Search and Filter Functions
  function filterStudentTable() {
    const searchInput = document
      .getElementById("studentSearchInput")
      .value.toLowerCase();
    const classFilter = document
      .getElementById("classFilterSelect")
      .value.toLowerCase();
    const strandFilter = document
      .getElementById("strandFilterSelect")
      .value.toLowerCase();
    const table = document.getElementById("studentTable");
    const rows = table
      .getElementsByTagName("tbody")[0]
      .getElementsByTagName("tr");
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
      if (rows[i].classList.contains("no-results-row")) continue;
      const lrnCell = rows[i].getElementsByTagName("td")[1]; // LRN is in column 1
      const classCell = rows[i].getElementsByTagName("td")[3]; // Class is in column 3
      const strandCell = rows[i].getElementsByTagName("td")[4]; // Strand is in column 4
      if (lrnCell && classCell && strandCell) {
        const lrnValue = lrnCell.textContent.toLowerCase();
        const classValue = classCell.textContent.toLowerCase();
        const strandValue = strandCell.textContent.toLowerCase();

        // Check LRN search, class filter, and strand filter
        const lrnMatch = lrnValue.includes(searchInput);
        const classMatch = classFilter === "" || classValue === classFilter;
        const strandMatch = strandFilter === "" || strandValue === strandFilter;

        if (lrnMatch && classMatch && strandMatch) {
          rows[i].style.display = "";
          visibleCount++;
        } else {
          rows[i].style.display = "none";
        }
      }
    }

    // Show "No results" message if no matches
    const tbody = table.getElementsByTagName("tbody")[0];
    let noResultsMsg = tbody.querySelector(".no-results-row");
    if (
      visibleCount === 0 &&
      (searchInput !== "" || classFilter !== "" || strandFilter !== "")
    ) {
      if (!noResultsMsg) {
        const row = tbody.insertRow();
        row.className = "no-results-row";
        const cell = row.insertCell(0);
        cell.colSpan = 6;
        cell.innerHTML =
          '<div class="no-results">No students found matching the criteria</div>';
      }
    } else if (noResultsMsg) {
      noResultsMsg.remove();
    }
  }

  function filterTeacherTable() {
    const searchInput = document
      .getElementById("teacherSearchInput")
      .value.toLowerCase();
    const table = document.getElementById("teacherTable");
    const rows = table
      .getElementsByTagName("tbody")[0]
      .getElementsByTagName("tr");
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
      if (rows[i].classList.contains("no-results-row")) continue;
      const teacherCodeCell = rows[i].getElementsByTagName("td")[1]; // Teacher Code is in column 1
      if (teacherCodeCell) {
        const teacherCodeValue = teacherCodeCell.textContent.toLowerCase();
        if (teacherCodeValue.includes(searchInput)) {
          rows[i].style.display = "";
          visibleCount++;
        } else {
          rows[i].style.display = "none";
        }
      }
    }

    // Show "No results" message if no matches
    const tbody = table.getElementsByTagName("tbody")[0];
    let noResultsMsg = tbody.querySelector(".no-results-row");
    if (visibleCount === 0 && searchInput !== "") {
      if (!noResultsMsg) {
        const row = tbody.insertRow();
        row.className = "no-results-row";
        const cell = row.insertCell(0);
        cell.colSpan = 5;
        cell.innerHTML =
          '<div class="no-results">No teachers found with this code</div>';
      }
    } else if (noResultsMsg) {
      noResultsMsg.remove();
    }
  }

  // Pagination Variables and Functions
  const itemsPerPage = {{ items_per_page }};
  let currentStudentPage = 1;
  let currentTeacherPage = 1;

  function paginate(tableId, page, section) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
    const totalRows = Array.from(rows).filter(row => !row.classList.contains("no-results-row")).length;
    const totalPages = Math.ceil(totalRows / itemsPerPage);

    let visibleCount = 0;
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;

    for (let i = 0; i < rows.length; i++) {
      if (rows[i].classList.contains("no-results-row")) continue;

      if (visibleCount >= startIndex && visibleCount < endIndex) {
        rows[i].style.display = "";
      } else {
        rows[i].style.display = "none";
      }
      visibleCount++;
    }

    // Update page display
    if (section === "student") {
      currentStudentPage = page;
      document.getElementById("studentCurrentPage").textContent = page;
      document.getElementById("studentTotalPages").textContent = totalPages;
      document.getElementById("studentPrevBtn").disabled = page === 1;
      document.getElementById("studentNextBtn").disabled = page === totalPages;
    } else if (section === "teacher") {
      currentTeacherPage = page;
      document.getElementById("teacherCurrentPage").textContent = page;
      document.getElementById("teacherTotalPages").textContent = totalPages;
      document.getElementById("teacherPrevBtn").disabled = page === 1;
      document.getElementById("teacherNextBtn").disabled = page === totalPages;
    }
  }

  function previousStudentPage() {
    if (currentStudentPage > 1) {
      paginate("studentTable", currentStudentPage - 1, "student");
    }
  }

  function nextStudentPage() {
    const table = document.getElementById("studentTable");
    const rows = Array.from(table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"))
      .filter(row => !row.classList.contains("no-results-row"));
    const totalPages = Math.ceil(rows.length / itemsPerPage);
    if (currentStudentPage < totalPages) {
      paginate("studentTable", currentStudentPage + 1, "student");
    }
  }

  function previousTeacherPage() {
    if (currentTeacherPage > 1) {
      paginate("teacherTable", currentTeacherPage - 1, "teacher");
    }
  }

  function nextTeacherPage() {
    const table = document.getElementById("teacherTable");
    const rows = Array.from(table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"))
      .filter(row => !row.classList.contains("no-results-row"));
    const totalPages = Math.ceil(rows.length / itemsPerPage);
    if (currentTeacherPage < totalPages) {
      paginate("teacherTable", currentTeacherPage + 1, "teacher");
    }
  }

  // Delete Confirmation Modal Functions
  let deleteData = { type: null, id: null };

  function openDeleteModal(type, id, name) {
    deleteData.type = type;
    deleteData.id = id;
    document.getElementById("deleteModalName").textContent = name;
    document.getElementById("deleteModal").classList.add("show");
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").classList.remove("show");
  }

  function confirmDelete() {
    const type = deleteData.type;
    const id = deleteData.id;
    let url = "";

    if (type === "student") {
      url = `/delete_student/${id}`;
    } else if (type === "teacher") {
      url = `/delete_teacher/${id}`;
    }

    fetch(url, {
      method: "POST",
    })
      .then((response) => {
        if (response.ok) {
          location.reload();
        }
      })
      .catch((error) => console.error("Error:", error));

    closeDeleteModal();
  }

  // Form validation functions
  function validateStudentForm() {
    const studentLRN = document
      .querySelector('#addStudentForm input[name="studentLRN"]')
      .value.trim();
    const name = document
      .querySelector('#addStudentForm input[name="name"]')
      .value.trim();
    const dob = document.querySelector(
      '#addStudentForm input[name="dob"]'
    ).value;

    // Validate LRN
    if (studentLRN.length < 3) {
      alert("Student LRN must be at least 3 characters long");
      return false;
    }
    if (!/^[a-zA-Z0-9-]+$/.test(studentLRN)) {
      alert("LRN should contain only letters, numbers, and hyphens");
      return false;
    }

    // Validate name
    if (name.length < 3) {
      alert("Full name must be at least 3 characters long");
      return false;
    }
    if (!/^[a-zA-Z\s]+$/.test(name)) {
      alert("Name should contain only letters and spaces");
      return false;
    }

    // Validate date of birth
    if (!dob) {
      alert("Date of birth is required");
      return false;
    }
    const dobDate = new Date(dob);
    const today = new Date();
    if (dobDate >= today) {
      alert("Date of birth must be in the past");
      return false;
    }

    return true;
  }

  function validateTeacherForm() {
    const teacherID = document
      .querySelector('#addTeacherForm input[name="teacherID"]')
      .value.trim();
    const name = document
      .querySelector('#addTeacherForm input[name="name"]')
      .value.trim();
    const department = document
      .querySelector('#addTeacherForm input[name="department"]')
      .value.trim();
    const dob = document.querySelector(
      '#addTeacherForm input[name="dob"]'
    ).value;

    // Validate Teacher ID
    if (teacherID.length < 3) {
      alert("Teacher ID must be at least 3 characters long");
      return false;
    }
    if (!/^[a-zA-Z0-9-]+$/.test(teacherID)) {
      alert("Teacher ID should contain only letters, numbers, and hyphens");
      return false;
    }

    // Validate name
    if (name.length < 3) {
      alert("Full name must be at least 3 characters long");
      return false;
    }
    if (!/^[a-zA-Z\s]+$/.test(name)) {
      alert("Name should contain only letters and spaces");
      return false;
    }

    // Validate department
    if (department.length < 2) {
      alert("Department is required");
      return false;
    }

    // Validate date of birth
    if (!dob) {
      alert("Date of birth is required");
      return false;
    }
    const dobDate = new Date(dob);
    const today = new Date();
    if (dobDate >= today) {
      alert("Date of birth must be in the past");
      return false;
    }

    return true;
  }
</script>

<!-- Edit Student Modal -->
<div id="editStudentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Student</h2>
      <button class="close" onclick="closeEditStudentModal()">&times;</button>
    </div>
    <form id="editStudentForm" class="form-card">
      <input type="hidden" id="editStudentId" />
      <input
        type="text"
        id="editStudentLRN"
        placeholder="Student LRN"
        required
      />
      <input
        type="text"
        id="editStudentName"
        placeholder="Full Name"
        required
      />
      <input
        type="text"
        id="editStudentClass"
        placeholder="Class/Grade"
        required
      />
      <input
        type="text"
        id="editStudentStrand"
        placeholder="Strand (e.g., STEM, ABM, HUMSS)"
      />
      <input type="date" id="editStudentDOB" />
      <input type="text" id="editStudentAddress" placeholder="Address" />
      <input
        type="text"
        id="editStudentParentContact"
        placeholder="Parent/Guardian's Name"
      />
      <input
        type="text"
        id="editStudentEmergencyContact"
        placeholder="Emergency Contact"
      />
      <input type="text" id="editStudentHeight" placeholder="Height" />
      <input type="text" id="editStudentWeight" placeholder="Weight" />
      <input type="text" id="editStudentBlood" placeholder="Blood Type" />
      <textarea
        id="editStudentPastIllnesses"
        placeholder="Past Illnesses"
        maxlength="500"
      ></textarea>
      <textarea
        id="editStudentAllergies"
        placeholder="Allergies"
        maxlength="500"
      ></textarea>
      <textarea
        id="editStudentConditions"
        placeholder="Pre-existing Conditions"
        maxlength="500"
      ></textarea>
      <input
        type="text"
        id="editStudentVaccination"
        placeholder="Vaccination Status"
      />
      <button type="submit" class="btn-primary">Save Changes</button>
    </form>
  </div>
</div>

<!-- Edit Teacher Modal -->
<div id="editTeacherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Teacher</h2>
      <button class="close" onclick="closeEditTeacherModal()">&times;</button>
    </div>
    <form id="editTeacherForm" class="form-card">
      <input type="hidden" id="editTeacherId" />
      <input type="text" id="editTeacherID" placeholder="Teacher ID" required />
      <input
        type="text"
        id="editTeacherName"
        placeholder="Full Name"
        required
      />
      <input
        type="text"
        id="editTeacherDept"
        placeholder="Department"
        required
      />
      <input type="date" id="editTeacherDOB" />
      <input type="text" id="editTeacherAddress" placeholder="Address" />
      <input type="text" id="editTeacherContact" placeholder="Contact Number" />
      <input type="text" id="editTeacherHeight" placeholder="Height" />
      <input type="text" id="editTeacherWeight" placeholder="Weight" />
      <input type="text" id="editTeacherBlood" placeholder="Blood Type" />
      <textarea
        id="editTeacherPastIllnesses"
        placeholder="Past Illnesses"
        maxlength="500"
      ></textarea>
      <textarea
        id="editTeacherAllergies"
        placeholder="Allergies"
        maxlength="500"
      ></textarea>
      <textarea
        id="editTeacherConditions"
        placeholder="Pre-existing Conditions"
        maxlength="500"
      ></textarea>
      <input
        type="text"
        id="editTeacherVaccination"
        placeholder="Vaccination Status"
      />
      <button type="submit" class="btn-primary">Save Changes</button>
    </form>
  </div>
</div>

<script>
  function openEditStudentModal(
    id,
    lrn,
    name,
    classVal,
    strand,
    dob,
    address,
    parentContact,
    emergencyContact,
    height,
    weight,
    blood,
    pastIllnesses,
    allergies,
    conditions,
    vaccination
  ) {
    document.getElementById("editStudentId").value = id;
    document.getElementById("editStudentLRN").value = lrn;
    document.getElementById("editStudentName").value = name;
    document.getElementById("editStudentClass").value = classVal;
    document.getElementById("editStudentStrand").value = strand;
    document.getElementById("editStudentDOB").value = dob;
    document.getElementById("editStudentAddress").value = address;
    document.getElementById("editStudentParentContact").value = parentContact;
    document.getElementById("editStudentEmergencyContact").value =
      emergencyContact;
    document.getElementById("editStudentHeight").value = height;
    document.getElementById("editStudentWeight").value = weight;
    document.getElementById("editStudentBlood").value = blood;
    document.getElementById("editStudentPastIllnesses").value = pastIllnesses;
    document.getElementById("editStudentAllergies").value = allergies;
    document.getElementById("editStudentConditions").value = conditions;
    document.getElementById("editStudentVaccination").value = vaccination;

    document.getElementById("editStudentModal").classList.add("show");
  }

  function closeEditStudentModal() {
    document.getElementById("editStudentModal").classList.remove("show");
  }

  function openEditTeacherModal(
    id,
    teacherID,
    name,
    department,
    dob,
    address,
    contact,
    height,
    weight,
    blood,
    pastIllnesses,
    allergies,
    conditions,
    vaccination
  ) {
    document.getElementById("editTeacherId").value = id;
    document.getElementById("editTeacherID").value = teacherID;
    document.getElementById("editTeacherName").value = name;
    document.getElementById("editTeacherDept").value = department;
    document.getElementById("editTeacherDOB").value = dob;
    document.getElementById("editTeacherAddress").value = address;
    document.getElementById("editTeacherContact").value = contact;
    document.getElementById("editTeacherHeight").value = height;
    document.getElementById("editTeacherWeight").value = weight;
    document.getElementById("editTeacherBlood").value = blood;
    document.getElementById("editTeacherPastIllnesses").value = pastIllnesses;
    document.getElementById("editTeacherAllergies").value = allergies;
    document.getElementById("editTeacherConditions").value = conditions;
    document.getElementById("editTeacherVaccination").value = vaccination;

    document.getElementById("editTeacherModal").classList.add("show");
  }

  function closeEditTeacherModal() {
    document.getElementById("editTeacherModal").classList.remove("show");
  }

  // Handle student form submission
  document
    .getElementById("editStudentForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const studentId = document.getElementById("editStudentId").value;

      const formData = new FormData();
      formData.append(
        "studentLRN",
        document.getElementById("editStudentLRN").value
      );
      formData.append("name", document.getElementById("editStudentName").value);
      formData.append(
        "class",
        document.getElementById("editStudentClass").value
      );
      formData.append(
        "strand",
        document.getElementById("editStudentStrand").value
      );
      formData.append("dob", document.getElementById("editStudentDOB").value);
      formData.append(
        "address",
        document.getElementById("editStudentAddress").value
      );
      formData.append(
        "parentContact",
        document.getElementById("editStudentParentContact").value
      );
      formData.append(
        "emergencyContact",
        document.getElementById("editStudentEmergencyContact").value
      );
      formData.append(
        "height",
        document.getElementById("editStudentHeight").value
      );
      formData.append(
        "weight",
        document.getElementById("editStudentWeight").value
      );
      formData.append(
        "blood",
        document.getElementById("editStudentBlood").value
      );
      formData.append(
        "pastIllnesses",
        document.getElementById("editStudentPastIllnesses").value
      );
      formData.append(
        "allergies",
        document.getElementById("editStudentAllergies").value
      );
      formData.append(
        "conditions",
        document.getElementById("editStudentConditions").value
      );
      formData.append(
        "vaccination",
        document.getElementById("editStudentVaccination").value
      );

      try {
        const response = await fetch(`/edit_student/${studentId}`, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        if (result.success) {
          Swal.fire({
            icon: "success",
            title: "Success",
            text: "Student updated successfully!",
            timer: 1500,
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: result.message,
          });
        }
      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Error updating student: " + error,
        });
      }
    });

  // Handle teacher form submission
  document
    .getElementById("editTeacherForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const teacherId = document.getElementById("editTeacherId").value;

      const formData = new FormData();
      formData.append(
        "teacherID",
        document.getElementById("editTeacherID").value
      );
      formData.append("name", document.getElementById("editTeacherName").value);
      formData.append(
        "department",
        document.getElementById("editTeacherDept").value
      );
      formData.append("dob", document.getElementById("editTeacherDOB").value);
      formData.append(
        "address",
        document.getElementById("editTeacherAddress").value
      );
      formData.append(
        "contact",
        document.getElementById("editTeacherContact").value
      );
      formData.append(
        "height",
        document.getElementById("editTeacherHeight").value
      );
      formData.append(
        "weight",
        document.getElementById("editTeacherWeight").value
      );
      formData.append(
        "blood",
        document.getElementById("editTeacherBlood").value
      );
      formData.append(
        "pastIllnesses",
        document.getElementById("editTeacherPastIllnesses").value
      );
      formData.append(
        "allergies",
        document.getElementById("editTeacherAllergies").value
      );
      formData.append(
        "conditions",
        document.getElementById("editTeacherConditions").value
      );
      formData.append(
        "vaccination",
        document.getElementById("editTeacherVaccination").value
      );

      try {
        const response = await fetch(`/edit_teacher/${teacherId}`, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        if (result.success) {
          Swal.fire({
            icon: "success",
            title: "Success",
            text: "Teacher updated successfully!",
            timer: 1500,
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: result.message,
          });
        }
      } catch (error) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Error updating teacher: " + error,
        });
      }
    });

  // Close edit modals when clicking outside the modal content
  document.addEventListener("click", function (event) {
    const editStudentModal = document.getElementById("editStudentModal");
    const editTeacherModal = document.getElementById("editTeacherModal");

    // Only close if clicking directly on the modal backdrop
    if (editStudentModal && event.target === editStudentModal) {
      editStudentModal.classList.remove("show");
    }
    if (editTeacherModal && event.target === editTeacherModal) {
      editTeacherModal.classList.remove("show");
    }
  });

  // Prevent modal from closing when clicking inside the form
  const editStudentForm = document.getElementById("editStudentForm");
  if (editStudentForm) {
    editStudentForm.addEventListener("click", function (event) {
      event.stopPropagation();
    });
  }

  const editTeacherForm = document.getElementById("editTeacherForm");
  if (editTeacherForm) {
    editTeacherForm.addEventListener("click", function (event) {
      event.stopPropagation();
    });
  }

  // Initialize Pagination
  document.addEventListener("DOMContentLoaded", function () {
    const studentTable = document.getElementById("studentTable");
    const teacherTable = document.getElementById("teacherTable");

    if (studentTable && document.getElementById("studentPaginationContainer")) {
      paginate("studentTable", 1, "student");
    }

    if (teacherTable && document.getElementById("teacherPaginationContainer")) {
      paginate("teacherTable", 1, "teacher");
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock %}
