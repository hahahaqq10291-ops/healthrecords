{% extends "shared/base.html" %}

{% block extra_css %}
<style>
  .manage-users-container {
    width: 100%;
    margin: 0 auto;
    padding: 20px;
  }

  .users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 2px solid #a83e51;
    padding-bottom: 15px;
  }

  .users-header h1 {
    margin: 0;
    color: #333;
    font-size: 24px;
  }

  .add-user-btn {
    padding: 10px 20px;
    background: #8f2f41;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }

  .add-user-btn:hover {
    background: #a83e51;
  }

  .users-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    overflow-x: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin: 0 auto;
  }

  .users-table table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .users-table th {
    background: #a83e51;
    color: white;
    padding: 15px;
    text-align: center;
    font-weight: 600;
    border: none;
  }

  .users-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e0e0e0;
    text-align: center;
  }

  .users-table tbody tr {
    transition: background-color 0.2s;
  }

  .users-table tbody tr:hover {
    background-color: #f9f9f9;
  }

  .users-table tbody tr:last-child td {
    border-bottom: none;
  }

  .role-badge {
    display: inline-block;
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
  }

  .role-super_admin {
    background: #dc3545;
    color: white;
  }

  .role-health_officer {
    background: #28a745;
    color: white;
  }

  .role-teacher_view_only {
    background: #17a2b8;
    color: white;
  }

  .status-badge {
    display: inline-block;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
  }

  .status-active {
    background: #d4edda;
    color: #155724;
  }

  .status-inactive {
    background: #f8d7da;
    color: #721c24;
  }

  .role-select {
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
  }

  .user-actions {
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
  }

  .user-actions button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.3s;
    white-space: nowrap;
  }

  .btn-edit {
    background: #007bff;
    color: white;
  }

  .btn-edit:hover {
    background: #0056b3;
  }

  .btn-toggle {
    background: #ffc107;
    color: #333;
  }

  .btn-toggle:hover {
    background: #e0a800;
  }

  .btn-delete {
    background: #dc3545;
    color: white;
  }

  .btn-delete:hover {
    background: #c82333;
  }

  .btn-assign-class {
    background: #8f2f41;
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    transition: background 0.3s;
    white-space: nowrap;
  }

  .btn-assign-class:hover {
    background: #a83e51;
  }

  .advisory-class-display {
    font-weight: 600;
    color: black;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .modal-content {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    animation: slideDown 0.3s ease-out;
  }

  /* Scrollbar styling - Hidden */
  .modal-content::-webkit-scrollbar {
    width: 0;
    height: 0;
  }

  .modal-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-content::-webkit-scrollbar-thumb {
    background: transparent;
  }

  .modal-content::-webkit-scrollbar-thumb:hover {
    background: transparent;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    background: linear-gradient(135deg, #a83e51 0%, #a83e51 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 20px;
    font-weight: 700;
    border-bottom: 3px solid #8f2f41;
  }

  .modal-header h2 {
    margin: 0;
    color: white;
    font-size: 20px;
  }

  .modal-body {
    padding: 30px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
    transition: all 0.3s ease;
    background: #fff;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #a83e51;
    background: #f0f8ff;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    padding: 20px 30px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
    border-top: 1px solid #ddd;
  }

  .modal-actions button {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .btn-save {
    background: linear-gradient(135deg, #a83e51 0%, #8f2f41 100%);
    color: white;
    box-shadow: 0 4px 12px #6a1b2a(40, 167, 69, 0.3);
  }

  .btn-save:hover {
    background: linear-gradient(135deg, #a83e51 0%, #8f2f41 100%);
     box-shadow: 0 4px 12px #6a1b2a(40, 167, 69, 0.3);
    transform: translateY(-2px);
  }

  .btn-cancel {
    background: #6c757d;
    color: white;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.2);
  }

  .btn-cancel:hover {
    background: #5a6268;
    box-shadow: 0 6px 16px rgba(108, 117, 125, 0.3);
    transform: translateY(-2px);
  }

  .close {
    font-size: 28px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .modal-info {
    background:  #a83e51;
    border-left: 4px solid #8f2f41;
    padding: 12px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    color: white;
    font-size: 13px;
  }

  .modal-info strong {
    display: block;
    margin-bottom: 4px;
    color: white;
  }

  /* Notification Modal Styles */
  .notification-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease-in;
  }

  .notification-content {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s ease-out;
    min-width: 350px;
    max-width: 500px;
    overflow: hidden;
  }

  .notification-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 2px solid #eee;
  }

  .notification-header.success {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    color: white;
    border-bottom-color: #1e7e34;
  }

  .notification-header.error {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-bottom-color: #bd2130;
  }

  .notification-header.info {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-bottom-color: #004085;
  }

  .notification-icon {
    font-size: 24px;
    font-weight: bold;
  }

  .notification-title {
    font-size: 14px;
    font-weight: 700;
    margin: 0;
  }

  .notification-body {
    padding: 20px;
    color: #333;
    font-size: 12px;
    line-height: 1.6;
  }

  .notification-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #eee;
    text-align: right;
  }

  .notification-close-btn {
    padding: 6px 12px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
    transition: all 0.3s ease;
  }

  .notification-close-btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
  }

  .notification-close-btn.success {
    background: #28a745;
  }

  .notification-close-btn.success:hover {
    background: #218838;
  }

  .notification-close-btn.error {
    background: #dc3545;
  }

  .notification-close-btn.error:hover {
    background: #c82333;
  }

  @media (max-width: 768px) {
    .users-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .add-user-btn {
      margin-top: 10px;
    }

    .users-table th,
    .users-table td {
      padding: 10px;
      font-size: 13px;
    }

    .user-actions {
      flex-wrap: wrap;
    }
  }
</style>
{% endblock %}

{% block content %}

<!-- CSRF Token for API calls -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<div class="manage-users-container">
  <div class="users-header">
    <div>
      <h1> User Management</h1>
      <p style="color: #666; margin-top: 5px;">Manage user roles and permissions</p>
    </div>
    <button onclick="openAddUserModal()" class="add-user-btn">+ Add User</button>
  </div>

  <!-- Search Bar -->
  <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
    <input 
      type="text" 
      id="userSearchInput" 
      placeholder="Search by username..." 
      style="flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
      onkeyup="filterUsersByUsername()"
    >
    <button onclick="clearUserSearch()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Clear</button>
  </div>

  <div class="users-table">
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Advisory Class</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if users %}
          {% for user in users %}
          <tr>
            <td>{{ user['username'] }}</td>
            <td>{{ user['fullname'] }}</td>
            <td>{{ user['email'] }}</td>
            <td>
              <select class="role-select" data-user-id="{{ user['id'] }}" onchange="updateUserRole(this.dataset.userId, this.value)">
                {% for role_key, role_label in roles.items() %}
                <option value="{{ role_key }}" {% if user['role'] == role_key %}selected{% endif %}>
                  {{ role_label }}
                </option>
                {% endfor %}
              </select>
            </td>
            <td>
              {% if user['role'] == 'class_advisor' %}
                <span class="advisory-class-display" data-user-id="{{ user['id'] }}">
                  {{ user['advisory_class'] or 'Not assigned' }}
                </span>
                <button class="btn-assign-class" data-user-id="{{ user['id'] }}" data-user-name="{{ user['fullname'] }}" data-user-class="{{ user['advisory_class'] or '' }}" style="margin-left: 10px; font-size: 12px; padding: 4px 8px;">
                  Assign
                </button>
              {% else %}
                <span style="color: #999;">â€”</span>
              {% endif %}
            </td>
            <td>
              <span class="status-badge status-{% if user['is_active'] %}active{% else %}inactive{% endif %}">
                {% if user['is_active'] %}Active{% else %}Inactive{% endif %}
              </span>
            </td>
            <td>
              <div class="user-actions">
                <button class="btn-toggle" data-user-id="{{ user['id'] }}" data-is-active="{{ user['is_active']|int }}" onclick="toggleUserStatus(this)">
                  {% if user['is_active'] %}Deactivate{% else %}Activate{% endif %}
                </button>
                <button class="btn-delete" data-user-id="{{ user['id'] }}" data-user-name="{{ user['fullname'] }}" onclick="deleteUser(this)" style="margin-left: 5px; background: #dc3545;">
                  Delete
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" style="text-align: center; color: #999; padding: 30px;">No users found</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
  <div class="modal-content" style="max-width: 550px;">
    <div class="modal-header">
      <h2>Add New User</h2>
      <button class="close" onclick="closeAddUserModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addUserForm" onsubmit="return validateAddUserForm()">
        <div class="form-group">
          <label for="fullname"> Full Name:</label>
          <input type="text" id="fullname" placeholder="Enter full name" required minlength="3" maxlength="100" pattern="[a-zA-Z\s]+">
        </div>
        <div class="form-group">
          <label for="username"> Username:</label>
          <input type="text" id="username" placeholder="Enter unique username" required minlength="3" maxlength="50" pattern="[a-zA-Z0-9_]+">
        </div>
        <div class="form-group">
          <label for="email"> Email Address:</label>
          <input type="email" id="email" placeholder="Enter email address" required maxlength="120">
        </div>
        <div class="form-group">
          <label for="password"> Password:</label>
          <input type="password" id="password" placeholder="Enter strong password (min 6 characters)" required minlength="6" maxlength="100">
        </div>
        <div class="form-group">
          <label for="role"> Role:</label>
          <select id="role" required>
            <option value="">-- Select a role --</option>
            {% for role_key, role_label in roles.items() %}
            <option value="{{ role_key }}">{{ role_label }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" onclick="closeAddUserModal()">Cancel</button>
      <button type="submit" form="addUserForm" class="btn-save">âœ“ Create User</button>
    </div>
  </div>
</div>

<script>
  function openAddUserModal() {
    document.getElementById('addUserModal').style.display = 'block';
  }

  function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
    document.getElementById('addUserForm').reset();
  }

  window.onclick = function (event) {
    const modal = document.getElementById('addUserModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  };

  // Notification Modal Functions
  function showNotificationModal(title, message, type = 'success') {
    const notificationModal = document.getElementById('notificationModal');
    const notificationHeader = document.querySelector('.notification-header');
    const notificationTitle = document.querySelector('.notification-title');
    const notificationMessage = document.querySelector('.notification-message');
    const notificationIcon = document.querySelector('.notification-icon');

    if (!notificationModal) {
      console.error('[NOTIFICATION] Modal element not found!');
      // Fallback to SweetAlert instead of window.alert
      Swal.fire({
        icon: type === 'success' ? 'success' : type === 'error' ? 'error' : 'info',
        title: title,
        text: message
      });
      return;
    }

    // Set type-specific styling and icon
    notificationHeader.className = 'notification-header ' + type;
    
    if (type === 'success') {
      notificationIcon.textContent = 'âœ“';
    } else if (type === 'error') {
      notificationIcon.textContent = 'âœ•';
    } else {
      notificationIcon.textContent = 'â„¹';
    }

    notificationTitle.textContent = title;
    notificationMessage.textContent = message;

    notificationModal.style.display = 'block';
  }

  function closeNotificationModal() {
    const notificationModal = document.getElementById('notificationModal');
    notificationModal.style.display = 'none';
  }

  // Close notification modal when clicking close button
  function setupNotificationModal() {
    const closeBtn = document.querySelector('.notification-close-btn');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeNotificationModal);
    }

    const notificationModal = document.getElementById('notificationModal');
    if (notificationModal) {
      window.addEventListener('click', function(event) {
        if (event.target === notificationModal) {
          closeNotificationModal();
        }
      });
    }
  }

  // Setup notification modal on page load
  document.addEventListener('DOMContentLoaded', setupNotificationModal);

  function updateUserRole(userId, newRole) {
    fetch(`/api/user/${userId}/role`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ role: newRole })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotificationModal('Success', data.message, 'success');
          setTimeout(() => location.reload(), 3000);
        } else {
          showNotificationModal('Error', data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotificationModal('Error', error.message, 'error');
      });
  }

  function toggleUserStatus(button) {
    const userId = button.dataset.userId;
    const currentStatus = parseInt(button.dataset.isActive) === 1;
    
    fetch(`/api/user/${userId}/status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ is_active: !currentStatus })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotificationModal('Success', data.message, 'success');
          setTimeout(() => location.reload(), 3000);
        } else {
          showNotificationModal('Error', data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotificationModal('Error', error.message, 'error');
      });
  }

  function deleteUser(button) {
    const userId = button.dataset.userId;
    const userName = button.dataset.userName;
    
    // Show confirmation dialog using SweetAlert2
    Swal.fire({
      title: 'Delete User?',
      html: `<p>Are you sure you want to delete <strong>${userName}</strong>?</p><p style="color: #dc3545; font-weight: bold;">This action cannot be undone.</p>`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Delete',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        // User confirmed deletion
        fetch(`/api/user/${userId}/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotificationModal('Success', data.message, 'success');
              setTimeout(() => location.reload(), 3000);
            } else {
              showNotificationModal('Error', data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showNotificationModal('Error', error.message, 'error');
          });
      }
    });
  }

  document.getElementById('addUserForm').addEventListener('submit', function (e) {
    e.preventDefault();
    
    const fullname = document.getElementById('fullname').value.trim();
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const role = document.getElementById('role').value;
    
    if (!fullname || !username || !email || !password || !role) {
      showNotificationModal('Error', 'All fields are required', 'error');
      return;
    }

    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

    fetch('/api/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken || ''
      },
      body: JSON.stringify({
        fullname: fullname,
        username: username,
        email: email,
        password: password,
        role: role
      })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotificationModal('Success', 'User created successfully!', 'success');
          setTimeout(() => location.reload(), 3000);
        } else {
          showNotificationModal('Error', data.message, 'error');
        }
      })
      .catch(error => {
        console.error('[JS] Fetch error:', error);
        showNotificationModal('Error', error.message, 'error');
      });
  });

  // Event delegation for assign class buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-assign-class')) {
      const userId = e.target.dataset.userId;
      const userName = e.target.dataset.userName;
      const userClass = e.target.dataset.userClass;
      showAssignClassModal(userId, userName, userClass);
    }
  });

  // Advisory Class Assignment Functions
  function showAssignClassModal(userId, userName, currentClass) {
    document.getElementById('assignClassModal').style.display = 'block';
    document.getElementById('classAdvisorName').textContent = userName;
    document.getElementById('advisoryClassInput').value = currentClass || '';
    document.getElementById('assignClassForm').dataset.userId = userId;
  }

  function closeAssignClassModal() {
    document.getElementById('assignClassModal').style.display = 'none';
    document.getElementById('assignClassForm').reset();
  }

  // Form submission handler with better error handling
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('assignClassForm');
    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const userId = this.dataset.userId;
        const advisoryClass = document.getElementById('advisoryClassInput').value.trim();

        if (!userId) {
          showNotificationModal('Error', 'No user selected', 'error');
          return;
        }

        fetch(`/api/user/${userId}/advisory-class`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ advisory_class: advisoryClass })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              closeAssignClassModal();
              showNotificationModal('Success', data.message, 'success');
              setTimeout(() => location.reload(), 3000);
            } else {
              showNotificationModal('Error', data.message, 'error');
            }
          })
          .catch(error => {
            console.error('[JS] Fetch error:', error);
            showNotificationModal('Error', error.message, 'error');
          });
      });
    }
  });

  // Fallback: Also attach handler directly (in case DOMContentLoaded doesn't work)
  const assignForm = document.getElementById('assignClassForm');
  if (assignForm) {
    assignForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const userId = this.dataset.userId;
      const advisoryClass = document.getElementById('advisoryClassInput').value.trim();

      if (!userId) {
        showNotificationModal('Error', 'No user selected', 'error');
        return;
      }

      fetch(`/api/user/${userId}/advisory-class`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ advisory_class: advisoryClass })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closeAssignClassModal();
            showNotificationModal('Success', data.message, 'success');
            setTimeout(() => location.reload(), 3000);
          } else {
            showNotificationModal('Error', data.message, 'error');
          }
        })
        .catch(error => {
          console.error('[JS] Fetch error:', error);
          showNotificationModal('Error', error.message, 'error');
        });
    });
  }

  // Close modal when clicking outside of it
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('assignClassModal');
    if (event.target === modal) {
      closeAssignClassModal();
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Assign Advisory Class Modal -->
<div id="assignClassModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Assign Advisory Class</h2>
      <button class="close" onclick="closeAssignClassModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="assignClassForm" onsubmit="return validateAssignClassForm()">
        <div class="modal-info">
          <strong>Class Advisor:</strong>
          <span id="classAdvisorName"></span>
        </div>
        <div class="form-group">
          <label for="advisoryClassInput">ðŸ“š Enter Class/Section Name:</label>
          <input 
            type="text" 
            id="advisoryClassInput" 
            placeholder="e.g., Grade 7-A, Grade 8-B, 12-Fortran, etc." 
            required 
            minlength="2"
            maxlength="50"
            list="classNamesList"
            autocomplete="off"
          />
          <datalist id="classNamesList">
            {% for class_name in classes %}
            <option value="{{ class_name }}">{{ class_name }}</option>
            {% else %}
            <option value="">No existing classes (enter custom name)</option>
            {% endfor %}
          </datalist>
        </div>
      </form>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" onclick="closeAssignClassModal()">Cancel</button>
      <button type="submit" form="assignClassForm" class="btn-save">âœ“ Assign Class</button>
    </div>
  </div>
</div>

<script>
// Function to filter users by username
function filterUsersByUsername() {
  const searchInput = document.getElementById('userSearchInput');
  const searchValue = searchInput.value.toLowerCase();
  const table = document.querySelector('.users-table table');
  const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
  let visibleCount = 0;

  for (let i = 0; i < rows.length; i++) {
    const usernameCell = rows[i].getElementsByTagName('td')[0];
    
    if (usernameCell) {
      const username = usernameCell.textContent.toLowerCase();
      
      if (username.includes(searchValue)) {
        rows[i].style.display = '';
        visibleCount++;
      } else {
        rows[i].style.display = 'none';
      }
    }
  }

  // Show "No users found" message if no results
  const tbody = table.getElementsByTagName('tbody')[0];
  const noDataRow = tbody.querySelector('tr[colspan="7"]');
  
  if (visibleCount === 0) {
    if (!noDataRow) {
      const row = tbody.insertRow();
      row.innerHTML = '<td colspan="7" style="text-align: center; color: #999; padding: 30px;">No users found matching your search</td>';
    } else {
      noDataRow.style.display = '';
    }
  } else {
    if (noDataRow) {
      noDataRow.style.display = 'none';
    }
  }
}

// Function to clear search
function clearUserSearch() {
  document.getElementById('userSearchInput').value = '';
  filterUsersByUsername();
}
</script>

<!-- Notification Modal -->
<div id="notificationModal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <div class="notification-header success">
      <span class="notification-icon">âœ“</span>
    </div>
    <div class="notification-body">
      <h3 class="notification-title">Success</h3>
      <p class="notification-message">Operation completed successfully</p>
    </div>
    <div class="notification-footer">
      <button class="notification-close-btn">OK</button>
    </div>
  </div>
</div>

{% endblock %}
